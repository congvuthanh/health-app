# API Integration Documentation

## üöÄ Quick Start

### Common Operations

```typescript
// 1. Login
import { useAuthMutation } from 'hooks';
const { mutate: login } = useAuthMutation();
login({ data: { password: 'your-password' } });

// 2. Fetch Achievement Data
import { useAchievement } from 'hooks';
const { data, isLoading, error } = useAchievement();

// 3. Fetch Meal Records with Infinite Scroll
import { useMealRecordsInfinite } from 'hooks';
const { data, fetchNextPage, hasNextPage } = useMealRecordsInfinite({
  limit: 8,
});

// 4. Fetch Health Records
import { useHealthRecords } from 'hooks';
const { data } = useHealthRecords({ duration: 'year' });
```

### Commands

```bash
pnpm dev              # Start development server
pnpm generate:api     # Regenerate API code from OpenAPI schema
pnpm test             # Run tests
pnpm test:coverage    # Run tests with coverage
```

## Overview

This directory contains the API integration layer for the Health App:

- ‚úÖ Auto-generated TypeScript types and React Query hooks from OpenAPI schema
- ‚úÖ Custom API client with authentication and error handling
- ‚úÖ MSW handlers for testing
- ‚úÖ Authentication context and hooks
- ‚úÖ Ready for development with 80%+ test coverage

## Structure

```
api/
‚îú‚îÄ‚îÄ client.ts              # Axios client with auth interceptor
‚îú‚îÄ‚îÄ index.ts              # Main exports
‚îú‚îÄ‚îÄ schemas/              # OpenAPI schemas
‚îÇ   ‚îî‚îÄ‚îÄ api.swagger.json  # Source of truth for API
‚îî‚îÄ‚îÄ generated/            # Auto-generated by Orval (DO NOT EDIT)
    ‚îú‚îÄ‚îÄ default/
    ‚îÇ   ‚îú‚îÄ‚îÄ default.ts    # Generated React Query hooks
    ‚îÇ   ‚îî‚îÄ‚îÄ default.msw.ts # Generated MSW handlers
    ‚îî‚îÄ‚îÄ schemas/          # Generated TypeScript types
```

### Related Files

```
src/
‚îú‚îÄ‚îÄ contexts/AuthContext/     # Authentication state management
‚îú‚îÄ‚îÄ hooks/                    # Custom React Query hooks
‚îÇ   ‚îú‚îÄ‚îÄ useAuthMutation.ts    # Login hook
‚îÇ   ‚îú‚îÄ‚îÄ useTokenValidation.ts # Token validation
‚îÇ   ‚îú‚îÄ‚îÄ useAchievement.ts     # Achievement data
‚îÇ   ‚îú‚îÄ‚îÄ useNotifications.ts   # Notifications with pagination
‚îÇ   ‚îú‚îÄ‚îÄ useMealRecords.ts     # Meal records with pagination
‚îÇ   ‚îî‚îÄ‚îÄ useHealthRecords.ts   # Weight/body fat records
‚îî‚îÄ‚îÄ utils/test/
    ‚îú‚îÄ‚îÄ server.ts             # MSW mock server
    ‚îî‚îÄ‚îÄ test-utils.tsx        # Test utilities with providers
```

## Usage

### Authentication

```typescript
import { useAuthMutation } from 'hooks';

function LoginPage() {
  const { mutate: login, isPending } = useAuthMutation();

  const handleLogin = (password: string) => {
    login({ data: { password } });
  };

  return (
    <button onClick={() => handleLogin('password')} disabled={isPending}>
      {isPending ? 'Logging in...' : 'Login'}
    </button>
  );
}
```

### Fetching Data

```typescript
import { useAchievement } from 'hooks';

function AchievementCard() {
  const { data, isLoading, error } = useAchievement();

  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error loading data</div>;

  return (
    <div>
      <img src={data.imageUrl} alt={data.altText} />
      <p>Achievement: {data.achievementRate}%</p>
    </div>
  );
}
```

### Infinite Scrolling

```typescript
import { useMealRecordsInfinite } from 'hooks';

function MealList() {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
  } = useMealRecordsInfinite({ limit: 8 });

  return (
    <div>
      {data?.pages.map((page) =>
        page.items.map((meal) => <MealCard key={meal.id} meal={meal} />)
      )}

      {hasNextPage && (
        <button onClick={() => fetchNextPage()} disabled={isFetchingNextPage}>
          {isFetchingNextPage ? 'Loading...' : 'Load More'}
        </button>
      )}
    </div>
  );
}
```

## Available Hooks

### Authentication

- `useAuthMutation()` - Login and store access token
- `useTokenValidation()` - Validate current JWT token

### Data Fetching

- `useAchievement()` - Get today's achievement rate
- `useNotifications(params?)` - Get notifications with pagination
- `useNotificationsInfinite(params?)` - Infinite scroll notifications
- `useMealRecords(params?)` - Get meal records with pagination
- `useMealRecordsInfinite(params?)` - Infinite scroll meal records
- `useHealthRecords(params?)` - Get weight/body fat records

## API Endpoints

All endpoints are automatically typed and generated from the OpenAPI schema:

- `POST /signUp` - User authentication
- `GET /validateToken` - Validate JWT token
- `GET /myData/achievement` - Today's achievement data
- `GET /myData/notification` - Notifications list
- `GET /myData/record/meals` - Meal records
- `GET /myData/record/health` - Health records (weight/body fat)

## Regenerating API Code

When the OpenAPI schema changes:

```bash
# Fetch latest schema
curl -s https://health_app_api.dev-arent.workers.dev/schema | jq '.' > src/api/schemas/api.swagger.json

# Regenerate types and hooks
pnpm generate:api
```

## Testing

MSW handlers are automatically generated and integrated:

```typescript
import { render, screen } from 'utils/test';
import { server } from 'utils/test/server';
import { rest } from 'msw';

test('renders meal data', async () => {
  // MSW is already set up in vitest.setup.ts
  render(<MealList />);

  expect(await screen.findByText(/Dinner/i)).toBeInTheDocument();
});

test('handles API error', async () => {
  // Override handler for this test
  server.use(
    rest.get('/myData/record/meals', (req, res, ctx) => {
      return res(ctx.status(500));
    })
  );

  render(<MealList />);
  expect(await screen.findByText(/Error/i)).toBeInTheDocument();
});
```

## Authentication Flow

1. User logs in via `POST /signUp` with password
2. Access token is stored in localStorage
3. Axios interceptor automatically adds `Authorization: Bearer {token}` to all requests
4. On 401 error, token is cleared and user is redirected to `/authenticationError`

## Error Handling

The API client automatically handles:

- 401 Unauthorized ‚Üí Clears token and redirects to auth error page
- Response unwrapping ‚Üí Extracts `data` from API wrapper `{ status, code, message, data }`
- Request authentication ‚Üí Injects Bearer token from localStorage

## Type Safety

All API responses are fully typed:

```typescript
import type {
  GetMyDataRecordMeals200Data,
  GetMyDataRecordMeals200DataItemsItem,
} from 'api';

// Meal data is fully typed
const meal: GetMyDataRecordMeals200DataItemsItem = {
  id: 'abc123',
  createdAt: '2025-05-21T09:00:00.000Z',
  type: 'Dinner', // Only valid enum values allowed
  imageUrl: 'https://example.com/image.jpg',
  altText: 'Meal image',
};
```

## API Endpoints Reference

All endpoints are fully typed and available via custom hooks:

| Endpoint                    | Hook                                                | Description                   |
| --------------------------- | --------------------------------------------------- | ----------------------------- |
| `POST /signUp`              | `useAuthMutation()`                                 | User authentication           |
| `GET /validateToken`        | `useTokenValidation()`                              | Validate JWT token            |
| `GET /myData/achievement`   | `useAchievement()`                                  | Today's achievement rate      |
| `GET /myData/notification`  | `useNotifications()` / `useNotificationsInfinite()` | Notifications with pagination |
| `GET /myData/record/meals`  | `useMealRecords()` / `useMealRecordsInfinite()`     | Meal records with pagination  |
| `GET /myData/record/health` | `useHealthRecords()`                                | Weight/body fat records       |

## Authentication Flow

1. User logs in via `POST /signUp` with password
2. Access token is stored in `localStorage`
3. Axios interceptor automatically adds `Authorization: Bearer {token}` to all requests
4. On 401 error, token is cleared and user is redirected to `/authenticationError`

## Best Practices

1. ‚úÖ **Use custom hooks** in `src/hooks/` instead of generated hooks directly
2. ‚ö†Ô∏è **Never edit generated files** - they'll be overwritten on regeneration
3. üéØ **Handle loading/error states** in all components using hooks
4. ‚ôæÔ∏è **Use infinite queries** for paginated data (meals, notifications)
5. üß™ **Test with MSW** - handlers are auto-generated from schema
6. üîí **Check authentication** - Protected routes require valid JWT token
7. üìä **Leverage React Query caching** - Data is automatically cached and revalidated
